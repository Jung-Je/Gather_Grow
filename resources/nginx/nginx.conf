# WebSocket 연결 업그레이드를 위한 맵핑
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# Django HTTP 서비스 업스트림
upstream web {
    server web:8000;  # HTTP 요청용
}

# Django WebSocket 서비스 업스트림  
upstream websocket {
    server websocket:8001;  # WebSocket 요청용
}

server {
    listen 80;                # HTTP 포트 80에서 요청 수신
    server_name localhost;    # 서버 이름 (실제 배포 시 도메인으로 변경)

    # 보안 헤더 설정
    add_header X-Frame-Options "SAMEORIGIN" always;              # 클릭재킹 방지
    add_header X-Content-Type-Options "nosniff" always;          # MIME 타입 스니핑 방지
    add_header X-XSS-Protection "1; mode=block" always;          # XSS 공격 방지
    add_header Referrer-Policy "no-referrer-when-downgrade" always;  # 리퍼러 정책

    # 정적 파일 처리 (CSS, JS, 이미지 등)
    location /static/ {
        alias /app/staticfiles/;                          # Django의 정적 파일 경로
        expires 30d;                                      # 30일 캐시 설정
        add_header Cache-Control "public, immutable";     # 브라우저 캐시 제어
    }

    # 미디어 파일 처리 (사용자 업로드 파일)
    location /media/ {
        alias /app/media/;                               # Django의 미디어 파일 경로
        expires 30d;                                     # 30일 캐시 설정
        add_header Cache-Control "public";               # 브라우저 캐시 제어
    }

    # WebSocket 요청 처리 (/ws/ 경로)
    location /ws/ {
        proxy_pass http://websocket;                    # WebSocket 서비스로 전달
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 타임아웃 (더 길게 설정)
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # 나머지 모든 HTTP 요청을 Django로 프록시
    location / {
        proxy_pass http://web;                           # HTTP 서비스로 전달
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 일반 HTTP 타임아웃
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 헬스 체크 엔드포인트 (로드밸런서/모니터링 도구용)
    location /health/ {
        access_log off;                                  # 로그에 기록하지 않음
        return 200 "healthy\n";                         # 200 상태 코드와 응답 메시지
        add_header Content-Type text/plain;             # 응답 콘텐츠 타입 설정
    }
}